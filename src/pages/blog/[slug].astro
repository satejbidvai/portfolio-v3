---
import MainLayout from '../../layouts/main-layout.astro';
import BlogStructuredData from '../../components/blog/blog-structured-data.astro';
import SiteFooter from '../../components/site-footer.astro';
import { getAllPosts, getPostUrl } from '../../utils/blog';
import H2 from '../../components/blog/mdx/H2.astro';
import H3 from '../../components/blog/mdx/H3.astro';
import A from '../../components/blog/mdx/A.astro';
import Img from '../../components/blog/mdx/Img.astro';
import Code from '../../components/blog/mdx/Code.astro';
import InlineCode from '../../components/blog/mdx/InlineCode.astro';
import Link from '../../components/ui/Link.astro';

export async function getStaticPaths() {
  const posts = await getAllPosts();
  return posts.map((post) => ({ params: { slug: post.slug }, props: { post } }));
}

const MDX_COMPONENTS = { h2: H2, h3: H3, a: A, img: Img, code: Code, InlineCode } as const;

const { post } = Astro.props;
const postUrl = getPostUrl(post.slug);

const { Content } = await post.render();
---

<MainLayout title={post.data.title} description={post.data.description} url={postUrl} ogImage={post.data.ogImage}>
  <Fragment slot="head">
    <!-- Canonical URL (for re-post handling) -->
    {post.data.canonicalURL && <link rel="canonical" href={post.data.canonicalURL} />}

    <!-- Blog-specific Open Graph tags -->
    <meta property="og:type" content="article" />
    <meta property="article:published_time" content={post.data.publishDate.toISOString()} />

    <BlogStructuredData post={post.data} url={postUrl} />
  </Fragment>

  <article class="mt-8">
    <nav class="mb-6">
      <Link href="/blog" class="text-sm inline-flex items-center gap-1"> ‚Üê Back to Blog </Link>
    </nav>
    <header class="mb-8">
      <h1 class="text-3xl md:text-5xl font-bold leading-tight mb-4 text-pretty">{post.data.title}</h1>
      <div class="flex items-center gap-4 text-muted-foreground text-sm">
        <time datetime={post.data.publishDate.toISOString()}>
          {post.data.publishDate.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}
        </time>
      </div>
    </header>

    <div class="prose max-w-none dark:prose-invert">
      <Content components={MDX_COMPONENTS} />
    </div>
  </article>

  <SiteFooter />
</MainLayout>
